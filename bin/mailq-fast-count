#!/usr/bin/env perl
#
# mailq-fast-count
#
# Outputs a count of all messages in your postfix spool
#

use strict;
use warnings;
use Getopt::Long;
use Postfix::Mailq;

my @args = @ARGV;

GetOptions(
    'spool_dir:s' => \(my $spool_dir = Postfix::Mailq::DEFAULT_SPOOL_DIR),
    'hold'        => \(my $get_hold = 1),
);

my $count = Postfix::Mailq::get_fast_count({
    get_hold => $get_hold,
    spool_dir => $spool_dir,
});

# No postfix dir?
if (! $count || ref $count ne "HASH") {
    exit 1;
}

if ($count->{total} == 0) {
    print "Mail queue is empty\n";
    exit 0;
}

# Actual mailq output:
#
#-Queue ID- --Size-- ----Arrival Time---- -Sender/Recipient-------
#1DA356A26A6     1272 Fri Dec 23 14:19:28  www-data
#                                         xxxxxxxxx@yyyyyyyyyy.zzz
#
#                                         -- 1 Kbytes in 1 Request.
#
#

# ... but we cannot output this info, because we're only counting

for (keys %{ $count }) {
    printf "%s: %d\n", $_, $count->{$_};
}
